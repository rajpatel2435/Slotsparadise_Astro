pipelines:
  branches:
    master:
      - step:
          name: Build assets
          image: node:20.11.1
          script:
            # Install dependencies and build assets
            - npm install
            - echo GRAPHQL_ENDPOINT=https://slotsparadise.com/wp-graphql >> .env.production
            - echo ADMIN_AJAX_ENDPOINT=https://slotsparadise.com/wp-admin/admin-ajax.php >> .env.production
            - npm run build
            # Save build assets as an artifact
          artifacts:
            - dist/**
            - node_modules/**
            - .env.production
      - step:
          name: Rsync to production server and notify Mattermost
          script:
            # Copy .env file to the server
            - scp .env.production $MKTCASINOS_USER_DEV@$MKTCASINOS_SERVER_DEV:applications/szkhyquxps/public_html/the-beach/

            # Stop the lobby process to commit changes
            - ssh $MKTCASINOS_USER@$MKTCASINOS_SERVER "pm2 stop beach"

            # Update the remote with rsync
            - rsync -zrSlh --delete --stats ./* $MKTCASINOS_USER@$MKTCASINOS_SERVER:applications/szkhyquxps/public_html/the-beach

            # Copy .htaccess file to the server
            - scp .htaccess $MKTCASINOS_USER@$MKTCASINOS_SERVER:applications/szkhyquxps/public_html/the-beach/

            # Stop the lobby process to commit changes
            - ssh $MKTCASINOS_USER@$MKTCASINOS_SERVER "pm2 start beach"

            # Send message to MatterMost
            - COMMIT_MESSAGE=$(git log --format=%B -n 1 $BITBUCKET_COMMIT)
            - COMMIT_DATE=$(git log -n 1 --pretty=format:'%ci' $BITBUCKET_COMMIT)
            - COMMIT_AUTHOR=$(git log -n 1 --pretty=format:'%an' $BITBUCKET_COMMIT)
            - >
              curl -d '{
                  "channel": "wp-team-activity",
                  "username": "Bitbucket Pipelines",
                  "text": "New commit deployed to #SlotsParadise **master** branch on ```Astro slotsparadise``` with the following message: \n ```\n'"$COMMIT_MESSAGE"' \nEnv: AstroSlotsParadise\nDate: '"$COMMIT_DATE"'\nAuthor: '"$COMMIT_AUTHOR"'\n ```"
                }' -H "Content-Type: application/json" -X POST https://matter.dblexchange.com/hooks/t34yjuo6a3refeeafr3itdauge

    dev:
      - step:
          name: Build assets
          image: node:20.11.1
          script:
            # Install dependencies and build assets
            - npm install
            - echo GRAPHQL_ENDPOINT=https://wordpress-1233981-4586437.cloudwaysapps.com/wp-graphql >> .env.development
            - echo ADMIN_AJAX_ENDPOINT=https://wordpress-1233981-4586437.cloudwaysapps.com/wp-admin/admin-ajax.php >> .env.development
            - npm run build-dev
            # Save build assets as an artifact
          artifacts:
            - dist/**
            - node_modules/**
            - .env.development
      - step:
          name: Rsync to Development server and notify Mattermost
          script:
           # Copy .env file to the server
            - scp .env.development $MKTCASINOS_USER_DEV@$MKTCASINOS_SERVER_DEV:applications/qvucfjykmh/public_html/the-beach/

            # Stop the beach process to commit changes
            - ssh $MKTCASINOS_USER_DEV@$MKTCASINOS_SERVER_DEV "pm2 stop beach"

            # Update the remote with rsync
            - rsync -zrSlh --delete --stats ./* $MKTCASINOS_USER_DEV@$MKTCASINOS_SERVER_DEV:applications/qvucfjykmh/public_html/the-beach

            # Copy .htaccess file to the server
            - scp .htaccess $MKTCASINOS_USER_DEV@$MKTCASINOS_SERVER_DEV:applications/qvucfjykmh/public_html/the-beach/

            # Stop the beach process to commit changes
            - ssh $MKTCASINOS_USER_DEV@$MKTCASINOS_SERVER_DEV "pm2 start beach"

            # Send message to MatterMost
            - COMMIT_MESSAGE=$(git log --format=%B -n 1 $BITBUCKET_COMMIT)
            - COMMIT_DATE=$(git log -n 1 --pretty=format:'%ci' $BITBUCKET_COMMIT)
            - COMMIT_AUTHOR=$(git log -n 1 --pretty=format:'%an' $BITBUCKET_COMMIT)
            - >
              curl -d '{
                  "channel": "wp-team-activity",
                  "username": "Bitbucket Pipelines",
                  "text": "New commit deployed to #SlotsParadise **dev** branch on ```Astro slotsparadise``` with the following message: \n ```\n'"$COMMIT_MESSAGE"' \nEnv: AstroSlotsParadise\nDate: '"$COMMIT_DATE"'\nAuthor: '"$COMMIT_AUTHOR"'\n ```"
                }' -H "Content-Type: application/json" -X POST https://matter.dblexchange.com/hooks/t34yjuo6a3refeeafr3itdauge
